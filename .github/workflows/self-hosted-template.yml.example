name: Self-Hosted Runner Template

# This is a template showing best practices for self-hosted runners

on:
  workflow_dispatch:

jobs:
  example-job:
    runs-on: self-hosted
    
    # Optional: Clean workspace before starting
    # This ensures no leftover files from previous runs
    defaults:
      run:
        shell: bash
    
    steps:
      - name: Clean workspace
        run: |
          # Remove everything except hidden files (like .git)
          shopt -s extglob
          rm -rf !(.git|.|..)
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Clean checkout to avoid merge conflicts
          clean: true
          
      # For Node.js projects with pnpm
      - name: Setup pnpm (if needed)
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          # Note: caching might not work well on self-hosted runners
          # Consider disabling or using project-local cache
          
      - name: Configure pnpm for self-hosted runner
        if: steps.setup-pnpm.outcome == 'success'
        run: |
          # Use project-local store to avoid permission issues
          pnpm config set store-dir .pnpm-store
          # Disable global store
          pnpm config set use-store-server false
          
      - name: Install dependencies with pnpm
        if: steps.setup-pnpm.outcome == 'success'
        run: pnpm install --no-frozen-lockfile
        env:
          # Ensure pnpm uses local paths
          PNPM_HOME: ${{ github.workspace }}/.pnpm
          PNPM_STORE_PATH: ${{ github.workspace }}/.pnpm-store
          
      # For Android builds
      - name: Setup Java (if needed)
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          
      # Clean up after job
      - name: Post-job cleanup
        if: always()
        run: |
          # Clean up large directories to save space
          rm -rf node_modules .pnpm-store .pnpm
          rm -rf android/build android/.gradle
          # Add more cleanup as needed