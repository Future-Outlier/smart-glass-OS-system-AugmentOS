name: China Cloud Deploy Static Websites

on:
  push:
    branches:
      - ya/replace-auth-provider-websites
    paths:
      - "cloud/**"
      - ".github/workflows/china-deploy-static-websites.yml"

jobs:
  china-cloud-deploy-static-websites:
    name: Build & Deploy to Alibaba Cloud
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NODE_ENV: production
      OSS_BUCKET: mentra-dev-static-store
      OSS_CNAME: store.mentraglass.cn
      OSS_PATH: cloud/websites/store/dist
      CDN_PATH: "/*"

    steps:
      # 1ï¸âƒ£ Checkout source code
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        working-directory: cloud
        run: bun install --frozen-lockfile

      # 4ï¸âƒ£ Build project
      - name: Build project
        working-directory: cloud/websites/store
        run: bun run build

      # 5ï¸âƒ£ Install ossutil
      - name: Install ossutil
        run: |
          wget -O ossutil64 http://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      # 6ï¸âƒ£ Configure ossutil with CNAME support
      - name: Configure ossutil
        run: |
          cat > /tmp/ossutilconfig <<EOF
          [Credentials]
          language=EN
          endpoint=oss-cn-shenzhen.aliyuncs.com
          accessKeyID=${{ secrets.ALIBABA_ACCESS_KEY_ID }}
          accessKeySecret=${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}

          [Bucket-Cname]
          ${OSS_BUCKET}=${OSS_CNAME}
          EOF
          echo "âœ… Created ossutil config with CNAME mapping"

      # 7ï¸âƒ£ Upload static files to OSS using the CNAME domain
      - name: Upload static files to OSS
        run: |
          echo "ðŸš€ Uploading ${OSS_PATH}/ to oss://${OSS_BUCKET}/ via CNAME: ${OSS_CNAME}"
          ossutil -c /tmp/ossutilconfig sync ${OSS_PATH}/ oss://${OSS_BUCKET}/ \
            --delete \
            --force \
            --update
