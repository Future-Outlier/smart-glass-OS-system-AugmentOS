name: China Cloud Deploy Static Websites

on:
  push:
    branches:
      - ya/replace-auth-provider-websites
    paths:
      - "cloud/**"
      - ".github/workflows/china-deploy-static-websites.yml"

jobs:
  china-cloud-deploy-static-websites:
    name: Build & Deploy to Alibaba Cloud
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      NODE_ENV: production
      CLOUD_PUBLIC_HOST_NAME: api.mentraglass.cn
      ACR_REGION_ID: cn-shenzhen
      OSS_BUCKET: store
      OSS_PATH: cloud/websites/store/dist
      CDN_PATH: "/*"
      # ossutil configuration
      OSS_ENDPOINT: mentraglass.cn # Your custom domain/CNAME

    steps:
      # 1️⃣ Checkout source code
      - uses: actions/checkout@v4

      # 2️⃣ Setup Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 3️⃣ Install dependencies
      - name: Install dependencies
        working-directory: cloud
        run: bun install --frozen-lockfile

      # 4️⃣ Build project
      - name: Build project
        working-directory: cloud/websites/store
        run: bun run build

      # 5️⃣ Install and Configure ossutil
      - name: Install ossutil
        run: |
          wget -O ossutil64 http://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      # 6️⃣ Configure ossutil with CNAME support
      - name: Configure ossutil
        run: |
          ossutil config \
            -e $OSS_ENDPOINT \
            -i ${{ secrets.ALIBABA_ACCESS_KEY_ID }} \
            -k ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }} \
            -c /tmp/ossutilconfig

      # 7️⃣ Upload static files to OSS using sync
      - name: Upload static files to OSS
        run: |
          echo "Uploading $OSS_PATH to oss://$OSS_BUCKET/ using CNAME endpoint: $OSS_ENDPOINT"
          ossutil -c /tmp/ossutilconfig sync $OSS_PATH/ oss://$OSS_BUCKET/ \
            --delete \
            --force \
            --update
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIBABA_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}
