name: China Cloud Deployment

on:
  push:
    branches: [ya/china-cloud-cd]
    paths: ["cloud/**"]

jobs:
  china-cloud-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # 1. Checkout source code
      - uses: actions/checkout@v4

      # 2. Short commit SHA for tagging
      - id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      # 3. Compute Docker tags dynamically
      # - id: docker-tags
      #   run: |
      #     BRANCH=${GITHUB_REF_NAME//\//-}  # replace / with - for valid tag
      #     TAGS="${BRANCH}-${{ steps.vars.outputs.sha_short }}"
      #     # Add 'latest' only for main or release branches
      #     if [[ "$GITHUB_REF_NAME" == "main" || "$GITHUB_REF_NAME" == release/* ]]; then
      #       TAGS="$TAGS latest"
      #     fi
      #     echo "tags=$TAGS" >> "$GITHUB_OUTPUT"
      - id: docker-tags
        run: |
          BRANCH=${GITHUB_REF_NAME//\//-}  # replace / with -
          echo "tags=$BRANCH latest" >> "$GITHUB_OUTPUT"

      # 4. Docker Buildx
      - uses: docker/setup-buildx-action@v2

      # 5. Configure Alibaba Cloud credentials (prebuilt action)
      - name: Configure Alibaba Cloud
        uses: aliyun/configure-aliyun-credentials-action@v1
        with:
          access-key-id: ${{ secrets.ALIBABA_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALIBABA_ACCESS_KEY_SECRET }}
          region: cn-shenzhen

      # 6. AssumeRole â†’ generate STS token
      - id: sts
        run: |
          CREDS=$(aliyun sts AssumeRole \
            --profile default \
            --RoleArn "${{ secrets.ALIBABA_STS_ROLE_ARN }}" \
            --RoleSessionName "github-actions" \
            --DurationSeconds 3600 \
            --output json)
          echo "akid=$(jq -r '.Credentials.AccessKeyId' <<< "$CREDS")" >> "$GITHUB_OUTPUT"
          echo "token=$(jq -r '.Credentials.SecurityToken' <<< "$CREDS")" >> "$GITHUB_OUTPUT"

      # 7. Docker login with STS token
      - uses: docker/login-action@v1
        with:
          registry: mentra-acr-cnsz-a-registry.cn-shenzhen.cr.aliyuncs.com
          username: STS.${{ steps.sts.outputs.akid }}
          password: ${{ steps.sts.outputs.token }}

      # 8. Build & push Docker image
      - uses: docker/build-push-action@v4
        with:
          context: ./cloud
          file: ./cloud/docker/Dockerfile.porter
          push: true
          tags: ${{ steps.docker-tags.outputs.tags }}
