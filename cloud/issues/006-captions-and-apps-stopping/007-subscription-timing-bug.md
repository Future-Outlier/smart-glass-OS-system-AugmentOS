# Empty Subscriptions Bug - Investigation

> **STATUS**: Root cause IDENTIFIED. See **011-sdk-subscription-architecture-mismatch.md** for the full analysis.
>
> **TL;DR**: The SDK stores subscriptions in TWO places (`EventManager.handlers` and `AppSession.subscriptions`) that can drift out of sync. When they drift, empty subscriptions get sent to the cloud.

## Summary

After WebSocket 1006 closure, the SDK sends an empty subscriptions array to the cloud during reconnection, causing transcription to stop. The root cause is a **dual storage architecture mismatch** - subscriptions are stored separately from handlers, allowing them to drift.

## Key Evidence

### What the Logs Show

```
21:30:45.762 │ App WebSocket closed (code 1006)
21:30:45.763 │ "App com.mentra.captions.beta unexpectedly disconnected (code: 1006), starting grace period"
21:30:47.095 │ App reconnected, API key validated
21:30:47.126 │ "App connected (not from startApp) - moved to runningApps"  ← CRITICAL!
21:30:47.192 │ Received subscription update with EMPTY array
21:30:47.225 │ "App removed from transcription set"
21:30:47.330 │ "Receiving unauthorized audio - forcing mic off"
```

### Critical Log: "not from startApp"

The log `"App connected (not from startApp)"` is generated by this code in `AppManager.handleAppInit()`:

```typescript
// Resolve pending connection if it exists
const pending = this.pendingConnections.get(packageName)
if (pending) {
  // ... logs "successfully connected and authenticated"
  pending.resolve({success: true})
} else {
  // Log for existing connection (not from startApp)
  this.logger.info(`App ${packageName} connected (not from startApp) - moved to runningApps`)
}
```

**This proves:**

- There was NO pending connection
- `startApp()` was NOT called
- This was NOT a resurrection webhook
- This was a direct SDK auto-reconnect using the SAME AppSession object

## Disproven Theory

### Initial Theory: Resurrection Webhook (WRONG)

We initially theorized:

1. WebSocket closes with 1006
2. Cloud's 5-second grace period expires
3. Cloud triggers resurrection via `startApp()`
4. NEW AppSession created with empty subscriptions
5. Empty subscriptions sent before `onSession()` runs

**This theory is WRONG because:**

- Only 1.3 seconds elapsed between disconnect and reconnect
- Cloud's 5-second grace period hadn't expired
- Log says "not from startApp" - no resurrection occurred
- The same AppSession object reconnected

## The Mystery

If it's the same AppSession reconnecting, why is `this.subscriptions` empty?

### Places That Could Clear Subscriptions

```typescript
// 1. AppSession.disconnect() - explicitly clears
async disconnect(): Promise<void> {
  this.subscriptions.clear()  // ← Would clear subscriptions
}

// 2. AppSession.updateSubscriptionsFromSettings() - clears and rebuilds
private updateSubscriptionsFromSettings(): void {
  this.subscriptions.clear()  // ← Would clear subscriptions
  newSubscriptions.forEach((sub) => this.subscriptions.add(sub))
}

// 3. AppSession.unsubscribe() - removes individual subscriptions
unsubscribe(sub: SubscriptionRequest): void {
  this.subscriptions.delete(type)  // ← Would remove one subscription
}
```

### What We've Ruled Out

| Possibility                         | Ruled Out? | Reason                                                                       |
| ----------------------------------- | ---------- | ---------------------------------------------------------------------------- |
| Resurrection webhook                | ✅ Yes     | Log says "not from startApp"                                                 |
| `disconnect()` called               | ❓ Unknown | No log evidence either way                                                   |
| `updateSubscriptionsFromSettings()` | ✅ Yes     | Captions doesn't use settings-based subscriptions                            |
| `unsubscribe()` via cleanup         | ❓ Unknown | Would require Captions `dispose()` to be called                              |
| Captions `dispose()` called         | ❓ Unknown | Only called from `onStop`, which requires `sessionEnded` or `permanent` flag |
| `onStop` called                     | ❓ Unknown | Should only happen for permanent disconnections                              |

## Implementation Plan

### Phase 1: Add `getRegisteredStreams()` to EventManager

```typescript
// packages/sdk/src/app/session/events.ts
class EventManager {
  getRegisteredStreams(): ExtendedStreamType[] {
    return Array.from(this.handlers.keys())
  }
}
```

### Phase 2: Derive Subscriptions in `updateSubscriptions()`

```typescript
// packages/sdk/src/app/session/index.ts
private updateSubscriptions(): void {
  // DERIVE from handlers instead of using this.subscriptions
  const subs = this.events.getRegisteredStreams()

  const subscriptionPayload = subs.map((stream) => {
    const rate = this.streamRates.get(stream)
    if (rate && stream === StreamType.LOCATION_STREAM) {
      return { stream: "location_stream", rate }
    }
    return stream
  })

  this.send({
    type: AppToCloudMessageType.SUBSCRIPTION_UPDATE,
    subscriptions: subscriptionPayload,
    // ...
  })
}
```

### Phase 3: Remove `this.subscriptions` Set

Once derived subscriptions are working:

- Remove `private subscriptions = new Set<ExtendedStreamType>()`
- Update `subscribe()` and `unsubscribe()` to just trigger `updateSubscriptions()`
- Remove `this.subscriptions.clear()` from `disconnect()`

## Files to Modify

| File                                     | Changes                                                 |
| ---------------------------------------- | ------------------------------------------------------- |
| `packages/sdk/src/app/session/events.ts` | Add `getRegisteredStreams()` method                     |
| `packages/sdk/src/app/session/index.ts`  | Derive subscriptions from handlers                      |
| `packages/sdk/src/app/session/index.ts`  | Update `subscribe()`, `unsubscribe()`                   |
| `packages/sdk/src/app/session/index.ts`  | Remove `this.subscriptions.clear()` from `disconnect()` |

## Status

- [x] Bug identified (empty subscriptions sent)
- [x] Evidence collected from logs
- [x] Initial theory (resurrection) disproven
- [x] **Root cause confirmed: Dual storage architecture mismatch (011)**
- [ ] Fix implemented: Derive subscriptions from handlers
- [ ] Fix verified

## Related Documents

- **011-sdk-subscription-architecture-mismatch.md** - **ROOT CAUSE** - Full analysis of dual storage problem
- **005-sdk-reconnect-empty-subscriptions-bug.md** - Original symptom documentation
- **008-system-confusion-points.md** - System complexity that makes debugging hard
- **009-architecture-brainstorm.md** - Broader architecture redesign including this fix
