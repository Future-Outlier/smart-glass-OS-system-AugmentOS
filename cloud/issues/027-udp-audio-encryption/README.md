# UDP Audio Encryption

Optional encryption for UDP audio packets to secure audio data in transit.

## Quick Context

**Current**: UDP audio packets are sent unencrypted. The `userIdHash` header is just for routing, not security.
**Proposed**: Client requests encryption via WS URL param. Cloud generates symmetric key, sends over TLS. Client encrypts UDP packets.

## Key Context

WebSocket traffic is already TLS-encrypted. UDP was added for lower latency audio streaming but UDP doesn't have built-in encryption. This is optional - clients that don't request encryption continue working as before (backwards compatible).

## Implementation

### Crypto Library

Using `tweetnacl` secretbox (pure JS, works in Bun and React Native):

- **Encryption**: XSalsa20-Poly1305 (symmetric authenticated encryption)
- **Key**: 32 bytes (generated by server, sent over TLS)
- **Nonce**: 24 bytes (random per packet)
- **Auth tag**: 16 bytes
- **Total overhead**: 40 bytes per packet

### Flow

```
1. Client connects: wss://cloud.mentra.glass/glasses-ws?udpEncryption=true

2. Server generates 32-byte symmetric key, sends in CONNECTION_ACK:
   { udpEncryption: { key: "base64...", algorithm: "xsalsa20-poly1305" } }

3. Client stores key, uses it to encrypt UDP packets:
   nacl.secretbox(audio, nonce, key)
   Packet: [userIdHash(4)|seq(2)|nonce(24)|ciphertext(audio+16)]

4. Server decrypts with same key:
   nacl.secretbox.open(ciphertext, nonce, key)
```

This is secure because:

- Key transmitted over TLS (WebSocket connection)
- Each session gets a unique key
- XSalsa20-Poly1305 provides encryption + authentication
- Keys garbage collected when session ends

### Packet Formats

**Unencrypted** (existing):

```
┌────────────────┬────────────────┬─────────────────────┐
│  userIdHash    │  sequence      │  audio data         │
│  (4 bytes BE)  │  (2 bytes BE)  │  (variable)         │
└────────────────┴────────────────┴─────────────────────┘
```

**Encrypted** (new):

```
┌────────────────┬────────────────┬──────────────────┬─────────────────────┐
│  userIdHash    │  sequence      │  nonce           │  ciphertext + tag   │
│  (4 bytes BE)  │  (2 bytes BE)  │  (24 bytes)      │  (audio + 16 bytes) │
└────────────────┴────────────────┴──────────────────┴─────────────────────┘
```

Header (6 bytes) stays the same for routing. Only payload is encrypted.

### Key Files Changed

**Cloud:**
| File | Change |
|------|--------|
| `packages/sdk/src/types/messages/cloud-to-glasses.ts` | Added `udpEncryption` field to `ConnectionAck` |
| `packages/cloud/src/services/udp/UdpCrypto.ts` | **NEW** - Crypto utilities (key gen, encrypt, decrypt) |
| `packages/cloud/src/services/session/UdpAudioManager.ts` | Key generation, storage, decryption |
| `packages/cloud/src/services/udp/UdpAudioServer.ts` | Decryption of incoming encrypted packets |
| `packages/cloud/src/services/websocket/bun-websocket.ts` | Parse `?udpEncryption=true`, include key in ACK |
| `packages/cloud/src/services/websocket/types.ts` | Added `udpEncryptionRequested` to `GlassesWebSocketData` |

**Mobile (React Native):**
| File | Change |
|------|--------|
| `mobile/src/app/_layout.tsx` | Added `react-native-get-random-values` polyfill import (must be first!) |
| `mobile/src/services/UdpCrypto.ts` | **NEW** - Crypto utilities (decrypt key, encrypt audio) |
| `mobile/src/services/UdpManager.ts` | Store key, encrypt packets in sendAudio/sendAudioRaw |
| `mobile/src/services/SocketComms.ts` | Extract key from CONNECTION_ACK, pass to UdpManager |
| `mobile/src/services/WebSocketManager.ts` | Added `?udpEncryption=true` query param to WebSocket URL |

### Key Numbers

| Parameter           | Value                                  |
| ------------------- | -------------------------------------- |
| Symmetric key       | 32 bytes                               |
| XSalsa20 nonce      | 24 bytes                               |
| Poly1305 auth tag   | 16 bytes                               |
| Total overhead      | 40 bytes/packet                        |
| Max UDP payload     | 1024 bytes                             |
| Max encrypted audio | ~960 bytes (16 LC3 frames at 60 bytes) |
| Latency overhead    | ~10-30μs per packet (negligible)       |

## Backwards Compatibility

- Clients without `udpEncryption=true` → no key in CONNECTION_ACK → raw UDP works as before
- Cloud checks `session.udpAudioManager.encryptionEnabled` before attempting decryption
- New client → old cloud: Falls back to unencrypted (no key in ACK)
- Old client → new cloud: Works normally (encryption never initialized)
- No breaking changes to existing clients

## Bugs Found During Testing

### 1. "no PRNG" Error (Mobile)

**Symptom**: `Error: no PRNG` when trying to send encrypted packets

**Cause**: `tweetnacl` uses `nacl.randomBytes()` which requires `crypto.getRandomValues()`, but React Native doesn't have this API by default.

**Fix**: Added `react-native-get-random-values` package and imported it at the very top of `_layout.tsx` (must be before any other imports):

```typescript
import "react-native-get-random-values" // Must be first - required for tweetnacl crypto
```

### 2. LC3 Frame Misalignment (Mobile)

**Symptom**: Audio defects/corruption when encryption enabled

**Cause**: When calculating chunk size for encrypted packets, we subtracted `ENCRYPTION_OVERHEAD` (40 bytes) from the frame-aligned chunk size _after_ alignment:

```typescript
// BAD: 960 - 40 = 920 bytes (920 / 60 = 15.33 frames - NOT ALIGNED!)
maxChunkSize = this.getMaxChunkSize() - ENCRYPTION_OVERHEAD
```

This resulted in 920-byte chunks which is not divisible by 60-byte LC3 frames, causing frames to be split across packets and corrupting the decoder.

**Fix**: Calculate frame alignment _after_ accounting for encryption overhead:

```typescript
// GOOD: Calculate alignment after accounting for overhead
const availableForAudio = MAX_AUDIO_CHUNK_SIZE_BASE - ENCRYPTION_OVERHEAD // 1018 - 40 = 978
const maxFrames = Math.floor(availableForAudio / frameSizeBytes) // 978 / 60 = 16 frames
maxChunkSize = maxFrames * frameSizeBytes // 16 * 60 = 960 bytes (properly aligned)
```

## Status

- [x] Investigate crypto libraries for Bun (using tweetnacl)
- [x] Implement cloud-side encryption support
  - [x] UdpCrypto utility module
  - [x] UdpAudioManager key generation + decryption
  - [x] UdpAudioServer decryption
  - [x] bun-websocket.ts query param parsing + CONNECTION_ACK
  - [x] SDK type updates
- [x] Implement mobile-side encryption (React Native)
  - [x] UdpCrypto utility module
  - [x] UdpManager encryption in sendAudio/sendAudioRaw
  - [x] SocketComms key extraction from CONNECTION_ACK
  - [x] WebSocketManager adds `?udpEncryption=true` param
  - [x] Added `react-native-get-random-values` polyfill
- [x] Fix bugs found during testing
  - [x] "no PRNG" error - added crypto polyfill
  - [x] LC3 frame misalignment - fixed chunk size calculation
- [ ] Test encrypted path end-to-end
- [ ] Verify backwards compatibility
- [ ] Deploy to production

## Related

- **028-phone-mic-audio-quality** - Audio quality fix discovered during this investigation
