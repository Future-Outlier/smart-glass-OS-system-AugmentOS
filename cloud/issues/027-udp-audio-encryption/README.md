# UDP Audio Encryption

Optional encryption for UDP audio packets to secure audio data in transit.

## Quick Context

**Current**: UDP audio packets are sent unencrypted. The `userIdHash` header is just for routing, not security.
**Proposed**: Client requests encryption via WS URL param. Cloud generates symmetric key, sends over TLS. Client encrypts UDP packets.

## Key Context

WebSocket traffic is already TLS-encrypted. UDP was added for lower latency audio streaming but UDP doesn't have built-in encryption. This is optional - clients that don't request encryption continue working as before (backwards compatible).

## Implementation

### Crypto Library

Using `tweetnacl` secretbox (pure JS, works in Bun and React Native):

- **Encryption**: XSalsa20-Poly1305 (symmetric authenticated encryption)
- **Key**: 32 bytes (generated by server, sent over TLS)
- **Nonce**: 24 bytes (random per packet)
- **Auth tag**: 16 bytes
- **Total overhead**: 40 bytes per packet

### Flow

```
1. Client connects: wss://cloud.mentra.glass/glasses-ws?udpEncryption=true

2. Server generates 32-byte symmetric key, sends in CONNECTION_ACK:
   { udpEncryption: { key: "base64...", algorithm: "xsalsa20-poly1305" } }

3. Client stores key, uses it to encrypt UDP packets:
   nacl.secretbox(audio, nonce, key)
   Packet: [userIdHash(4)|seq(2)|nonce(24)|ciphertext(audio+16)]

4. Server decrypts with same key:
   nacl.secretbox.open(ciphertext, nonce, key)
```

This is secure because:

- Key transmitted over TLS (WebSocket connection)
- Each session gets a unique key
- XSalsa20-Poly1305 provides encryption + authentication
- Keys garbage collected when session ends

### Packet Formats

**Unencrypted** (existing):

```
┌────────────────┬────────────────┬─────────────────────┐
│  userIdHash    │  sequence      │  audio data         │
│  (4 bytes BE)  │  (2 bytes BE)  │  (variable)         │
└────────────────┴────────────────┴─────────────────────┘
```

**Encrypted** (new):

```
┌────────────────┬────────────────┬──────────────────┬─────────────────────┐
│  userIdHash    │  sequence      │  nonce           │  ciphertext + tag   │
│  (4 bytes BE)  │  (2 bytes BE)  │  (24 bytes)      │  (audio + 16 bytes) │
└────────────────┴────────────────┴──────────────────┴─────────────────────┘
```

Header (6 bytes) stays the same for routing. Only payload is encrypted.

### Key Files Changed

**Cloud:**
| File | Change |
|------|--------|
| `packages/sdk/src/types/messages/cloud-to-glasses.ts` | Added `udpEncryption` field to `ConnectionAck` |
| `packages/cloud/src/services/udp/UdpCrypto.ts` | **NEW** - Crypto utilities (key gen, encrypt, decrypt) |
| `packages/cloud/src/services/session/UdpAudioManager.ts` | Key generation, storage, decryption |
| `packages/cloud/src/services/udp/UdpAudioServer.ts` | Decryption of incoming encrypted packets |
| `packages/cloud/src/services/websocket/bun-websocket.ts` | Parse `?udpEncryption=true`, include key in ACK |
| `packages/cloud/src/services/websocket/types.ts` | Added `udpEncryptionRequested` to `GlassesWebSocketData` |

**Mobile (React Native):**
| File | Change |
|------|--------|
| `mobile/src/services/UdpCrypto.ts` | **NEW** - Crypto utilities (decrypt key, encrypt audio) |
| `mobile/src/services/UdpManager.ts` | Store key, encrypt packets in sendAudio/sendAudioRaw |
| `mobile/src/services/SocketComms.ts` | Extract key from CONNECTION_ACK, pass to UdpManager |

### Key Numbers

| Parameter           | Value                                      |
| ------------------- | ------------------------------------------ |
| Symmetric key       | 32 bytes                                   |
| XSalsa20 nonce      | 24 bytes                                   |
| Poly1305 auth tag   | 16 bytes                                   |
| Total overhead      | 40 bytes/packet                            |
| Max UDP payload     | 1024 bytes                                 |
| Max encrypted audio | ~978 bytes (still fits 40ms LC3 at 48kbps) |

## Backwards Compatibility

- Clients without `udpEncryption=true` → no key in CONNECTION_ACK → raw UDP works as before
- Cloud checks `session.udpAudioManager.encryptionEnabled` before attempting decryption
- No breaking changes to existing clients

## Status

- [x] Investigate crypto libraries for Bun (using tweetnacl)
- [x] Implement cloud-side encryption support
  - [x] UdpCrypto utility module
  - [x] UdpAudioManager key generation + decryption
  - [x] UdpAudioServer decryption
  - [x] bun-websocket.ts query param parsing + CONNECTION_ACK
  - [x] SDK type updates
- [x] Implement mobile-side encryption (React Native)
  - [x] UdpCrypto utility module
  - [x] UdpManager encryption in sendAudio/sendAudioRaw
  - [x] SocketComms key extraction from CONNECTION_ACK
- [ ] Test encrypted path end-to-end
- [ ] Verify backwards compatibility

## Related

- **028-phone-mic-audio-quality** - Audio quality fix discovered during this investigation
