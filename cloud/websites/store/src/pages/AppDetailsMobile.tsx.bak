import React from "react"
import {ChevronLeft, Info, Share2} from "lucide-react"
import {Button} from "@/components/ui/button"
import {toast} from "sonner"
import GetMentraOSButton from "../components/GetMentraOSButton"
import {HardwareRequirementLevel} from "../types"
import {
  APP_TAGS,
  hardwareIcons,
  getPermissionIcon,
  getPermissionDescription,
  getAppTypeDisplay,
  AppDetailsMobileProps,
} from "./AppDetailsShared"

const AppDetailsMobile: React.FC<AppDetailsMobileProps> = ({
  app,
  theme,
  isAuthenticated,
  isWebView,
  installingApp,
  handleBackNavigation,
  handleInstall,
  handleUninstall,
  navigateToLogin,
}) => {
  return (
    <div className="px-6 py-6 pb-safe w-full">
      <div className="max-w-2xl mx-auto">
        {/* Back Button */}
        <button
          onClick={handleBackNavigation}
          className="flex items-center justify-center w-[40px] h-[40px] rounded-full mb-[24px] transition-all bg-secondary text-foreground"
          aria-label="Back to App Store">
          <ChevronLeft className="w-5 h-5" />
        </button>

        {/* Header - Mobile Layout */}
        <div className="mb-6">
          <div className="flex items-start gap-4 mb-6">
            {/* App Icon - Mobile */}
            <div className="flex-shrink-0">
              <img
                src={app.logoURL}
                alt={`${app.name} logo`}
                className="w-[80px] h-[80px] object-cover rounded-[24px] shadow-md"
                onError={(e) => {
                  ;(e.target as HTMLImageElement).src = "https://placehold.co/100x100/gray/white?text=App"
                }}
              />
            </div>

            {/* App Info - Mobile */}
            <div className="flex-1 min-w-0">
              {/* App Title */}
              <h1
                className="text-[20px]  leading-tight mb-[8px] font-semibold"
                style={{
                  fontFamily: '"Red Hat Display", sans-serif',
                  color: "var(--text-primary)",
                }}>
                {app.name}
              </h1>

              {/* Company Name • App Type */}
              <div
                className="text-[12px] mb-[8px] leading-tight"
                style={{
                  fontFamily: '"Red Hat Display", sans-serif',
                  color: "var(--text-secondary)",
                }}>
                {app.orgName || app.developerProfile?.company || "Mentra"} • {getAppTypeDisplay(app)}
              </div>

              {/* Tag Pills */}
              {APP_TAGS[app.name] && (
                <div className="flex items-center gap-2 flex-wrap">
                  {APP_TAGS[app.name].slice(0, 2).map((tag, index) => (
                    <div
                      key={index}
                      className="max-h-[24px] px-3 py-1 rounded-full text-[12px] font-normal leading-tight bg-secondary text-muted-foreground"
                      style={{
                        fontFamily: '"Red Hat Display", sans-serif',
                      }}>
                      {tag}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Buttons Section */}
          <div className="flex items-center mb-[24px] gap-2">
            {/* Get/Install Button */}
            {isAuthenticated ? (
              app.isInstalled ? (
                <Button
                  disabled={true}
                  className="flex-1 h-[36px] text-[14px] font-medium rounded-full opacity-40 cursor-not-allowed"
                  style={{
                    fontFamily: '"Red Hat Display", sans-serif',
                    backgroundColor: theme === "light" ? "#000000" : "#ffffff",
                    color: theme === "light" ? "#ffffff" : "#000000",
                  }}>
                  Installed
                </Button>
              ) : (
                <Button
                  onClick={handleInstall}
                  disabled={installingApp}
                  className="flex-1 h-[36px] text-[14px] font-medium rounded-full transition-all"
                  style={{
                    fontFamily: '"Red Hat Display", sans-serif',
                    backgroundColor: theme === "light" ? "#000000" : "#ffffff",
                    color: theme === "light" ? "#ffffff" : "#000000",
                  }}>
                  {installingApp ? "Getting…" : "Get"}
                </Button>
              )
            ) : (
              <Button
                onClick={navigateToLogin}
                className="flex-1 h-[36px] text-[14px] font-medium rounded-full transition-all"
                style={{
                  fontFamily: '"Red Hat Display", sans-serif',
                  backgroundColor: theme === "light" ? "#000000" : "#ffffff",
                  color: theme === "light" ? "#ffffff" : "#000000",
                }}>
                Get
              </Button>
            )}

            {/* Share Button */}
            <button
              className="min-w-[93px] h-[36px] flex items-center justify-center rounded-full border transition-colors  gap-1 text-[14px]"
              style={{
                borderColor: theme === "light" ? "#dadce0" : "rgba(255, 255, 255, 0.2)",
                color: theme === "light" ? "#000000" : "#ffffff",
              }}
              onClick={async () => {
                try {
                  await navigator.clipboard.writeText(window.location.href)
                  toast.success("Copied link")
                } catch {
                  toast.error("Failed to copy link")
                }
              }}>
              <Share2 className="w-[14px] h-[14px]" />
              Share
            </button>
          </div>

          {/* About this app Section */}
          <div className="mb-6">
            <h2
              className="text-[16px] font-semibold mb-[24px]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: "var(--text-primary)",
              }}>
              About this app
            </h2>
            <p
              className="text-[14px] font-normal leading-[1.6]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: "var(--text-secondary)",
              }}>
              {app.description || "No description available."}
            </p>
          </div>
        </div>

        {/* Offline Warning */}
        {app.isOnline === false && (
          <div className="mb-6">
            <div
              className="flex items-center  p-3 rounded-lg"
              style={{
                backgroundColor: theme === "light" ? "#FDECEA" : "rgba(255, 255, 255, 0.05)",

              }}>
              <Info
                className="h-5 w-5"
                style={{
                  color: theme === "light" ? "#B91C1C" : "#FCA5A5",
                }}
              />
              <span
                className="text-[14px]"
                style={{
                  color: theme === "light" ? "#B91C1C" : "#FCA5A5",
                }}>
                This app appears to be offline. Some actions may not work.
              </span>
            </div>
          </div>
        )}

        {/* All Sections Visible - No Dropdowns */}
        <div className="space-y-8">
          <div className="h-[1px] w-full bg-[var(--border)]"></div>

          {/* Permissions Section */}
          <div>
            <h2
              className="text-[16px] font-semibold mb-[24px]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#000000" : "#ffffff",
              }}>
              Permissions
            </h2>
            <p
              className="text-[14px] mb-4 leading-[1.6]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#5f6368" : "#9CA3AF",
              }}>
              Permissions that will be requested when using this app on your phone.
            </p>
            <div className="space-y-3">
              {app.permissions && app.permissions.length > 0 ? (
                app.permissions.map((permission, index) => (
                  <div
                    key={index}
                    className="flex items-center justify-between p-[16px] rounded-[16px] bg-secondary">
                    <div className="flex items-center">
                      <div
                        className=" h-9 flex items-center justify-center rounded-lg mr-[2px]"
                        style={{
                        }}>
                        <div
                          style={{
                            color: theme === "light" ? "#000000" : "#9CA3AF",
                          }}>
                          {getPermissionIcon(permission.type || "Display")}
                        </div>
                      </div>
                      <div
                        className="text-[14px] font-medium"
                        style={{
                          fontFamily: '"Red Hat Display", sans-serif',
                          color: theme === "light" ? "#000000" : "#E4E4E7",
                        }}>
                        {(permission.type || "Display").charAt(0).toUpperCase() + (permission.type || "Display").slice(1).toLowerCase()}
                      </div>
                    </div>
                    <div
                      className="text-[14px] text-right max-w-[45%]"
                      style={{
                        fontFamily: '"Red Hat Display", sans-serif',
                        color: theme === "light" ? "#5f6368" : "#9CA3AF",
                      }}>
                      {permission.description || getPermissionDescription(permission.type || "Display")}
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-6 rounded-lg bg-secondary">
                  <div className="text-[14px] font-medium text-foreground">
                    No special permissions required
                  </div>
                  <div className="text-[12px] mt-1 text-muted-foreground">
                    This app runs with standard system permissions only.
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="h-[1px] w-full bg-[var(--border)]"></div>

          {/* Hardware Section */}
          <div>
            <h2
              className="text-[16px] font-semibold mb-[24px]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#000000" : "#ffffff",
              }}>
              Hardware
            </h2>
            <p
              className="text-[14px] mb-4 leading-[1.6]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#5f6368" : "#9CA3AF",
              }}>
              Hardware components required or recommended for this app.
            </p>
            <div className="space-y-3">
              {app.hardwareRequirements && app.hardwareRequirements.length > 0 ? (
                app.hardwareRequirements.map((req, index) => (
                  <div
                    key={index}
                    className="flex  justify-between p-[15px] rounded-[16px] bg-secondary items-center">
                    <div className="flex items-center ">
                      <div
                        className=" h-9 flex items-center justify-center rounded-lg"
                        style={{
                          color: theme === "light" ? "#000000" : "#9CA3AF",
                        }}>
                        {hardwareIcons[req.type]}
                      </div>
                      <div
                        className="text-[14px] font-medium"
                        style={{
                          fontFamily: '"Red Hat Display", sans-serif',
                          color: theme === "light" ? "#000000" : "#E4E4E7",
                        }}>
                        {req.type.charAt(0).toUpperCase() + req.type.slice(1).toLowerCase()}
                      </div>
                    </div>
                    <div className="flex flex-col items-end gap-1">
                      {req.level && (
                        <div
                          className="text-[13px] font-medium"
                          style={{
                            color:
                              req.level === HardwareRequirementLevel.REQUIRED
                                ? theme === "light"
                                  ? "#DC2626"
                                  : "#FCA5A5"
                                : theme === "light"
                                  ? "#5f6368"
                                  : "#9CA3AF",
                          }}>
                          {req.level === HardwareRequirementLevel.REQUIRED ? "Required" : "Optional"}
                        </div>
                      )}
                      {req.description && (
                        <div
                          className="text-[12px] text-right"
                          style={{
                            fontFamily: '"Red Hat Display", sans-serif',
                            color: theme === "light" ? "#5f6368" : "#9CA3AF",
                          }}>
                          {req.description}
                        </div>
                      )}
                    </div>
                  </div>
                ))
              ) : (
                <div className="text-center py-6 rounded-lg bg-secondary">
                  <div className="text-[14px] font-medium text-foreground">
                    No specific hardware requirements
                  </div>
                  <div className="text-[12px] mt-1 text-muted-foreground">
                    This app works with any glasses configuration.
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="h-[1px] w-full bg-[var(--border)]"></div>

          {/* Contact Section */}
          <div>
            <h2
              className="text-[16px] font-semibold mb-[24px]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#000000" : "#ffffff",
              }}>
              Contact
            </h2>
            <p
              className="text-[14px] mb-4 leading-[1.6]"
              style={{
                fontFamily: '"Red Hat Display", sans-serif',
                color: theme === "light" ? "#5f6368" : "#9CA3AF",
              }}>
              Get in touch with the developer or learn more about this app.
            </p>
            <div className="space-y-3">
              <div className="flex justify-between items-center py-3">
                <span
                  className="text-[14px] font-medium"
                  style={{
                    color: theme === "light" ? "#5f6368" : "#9CA3AF",
                  }}>
                  Company
                </span>
                <span
                  className="text-[14px] font-normal text-right"
                  style={{
                    color: theme === "light" ? "#000000" : "#E4E4E7",
                  }}>
                  {app.orgName || app.developerProfile?.company || "Mentra"}
                </span>
              </div>

              {app.developerProfile?.website && (
                <div className="flex justify-between items-center py-3">
                  <span
                    className="text-[14px] font-medium"
                    style={{
                      color: theme === "light" ? "#5f6368" : "#9CA3AF",
                    }}>
                    Website
                  </span>
                  <a
                    href={app.developerProfile.website}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-[14px] font-normal hover:underline text-right"
                    style={{
                      color: theme === "light" ? "#0066CC" : "#4A9EFF",
                    }}>
                    {app.developerProfile.website}
                  </a>
                </div>
              )}

              {app.developerProfile?.contactEmail && (
                <div className="flex justify-between items-center py-3">
                  <span
                    className="text-[14px] font-medium"
                    style={{
                      color: theme === "light" ? "#5f6368" : "#9CA3AF",
                    }}>
                    Contact
                  </span>
                  <a
                    href={`mailto:${app.developerProfile.contactEmail}`}
                    className="text-[14px] font-normal hover:underline text-right"
                    style={{
                      color: theme === "light" ? "#0066CC" : "#4A9EFF",
                    }}>
                    {app.developerProfile.contactEmail}
                  </a>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Get MentraOS - Hide in React Native WebView */}
        {!isWebView && (
          <div className="text-center mb-8 mt-12">
            <div className="flex justify-center">
              <GetMentraOSButton size="small" />
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default AppDetailsMobile
