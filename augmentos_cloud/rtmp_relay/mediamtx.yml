###############################################
# General parameters

# Sets the verbosity of the program; available values are "error", "warn", "info", "debug".
logLevel: info
# Destinations of log messages; available values are "stdout", "file" and "syslog".
logDestinations: [stdout]

# Enable the HTTP API.
api: yes
# Address of the API listener.
apiAddress: :9997

###############################################
# RTMP parameters

# Disable support for the RTMP protocol.
rtmp: yes
# Address of the RTMP listener. This is needed only when encryption is "no" or "optional".
rtmpAddress: :1935

###############################################
# Path parameters

# These settings are path-dependent, and the map key is the name of the path.
# It's possible to use regular expressions by using a tilde as prefix.
# For example, "~^(test1|test2)$" will match both "test1" and "test2".
# For example, "~^prefix" will match all paths that start with "prefix".
# The settings under the path "all" are applied to all paths that do not match
# any of the path-specific settings.
paths:
  all:
    source: publisher
    
  # Match all live streams
  ~^live/.+/.+$:
    source: publisher
    
    # Run when stream is ready - forward to Cloudflare
    runOnReady: bash -c 'echo "Stream started: $MTX_PATH" && USER_ID_SANITIZED=$(echo $MTX_PATH | cut -d/ -f2) && STREAM_ID=$(echo $MTX_PATH | cut -d/ -f3) && USER_ID=${USER_ID_SANITIZED/-/@} && echo "Looking up CF URL for $USER_ID/$STREAM_ID" && RESPONSE=$(curl -s "$CLOUD_API_URL/api/rtmp-relay/cf-url/$USER_ID/$STREAM_ID") && echo "API Response: $RESPONSE" && CF_URL=$(echo "$RESPONSE" | grep -o "\"url\":\"[^\"]*" | grep -o "[^\"]*$") && if [ -z "$CF_URL" ]; then echo "ERROR: No CF_URL found"; exit 1; fi && echo "Forwarding to Cloudflare: $CF_URL" && exec ffmpeg -i rtmp://localhost:1935/$MTX_PATH -c:v libx264 -preset veryfast -tune zerolatency -profile:v baseline -level 3.1 -r 30 -g 60 -keyint_min 60 -sc_threshold 0 -b:v 2M -maxrate 2.5M -bufsize 4M -pix_fmt yuv420p -c:a aac -ar 44100 -ac 1 -b:a 128k -f flv "$CF_URL" -loglevel info'
    
    runOnReadyRestart: yes