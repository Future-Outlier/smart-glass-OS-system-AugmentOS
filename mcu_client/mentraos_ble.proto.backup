syntax = "proto3";

package mentraos.ble;

// ============================================
// Base Message Types
// ============================================

// All messages from phone to glasses
message PhoneToGlasses {
  string msg_id = 1;  // Optional message ID for request/response correlation
  
  oneof payload {
    // Connection Management
    DisconnectRequest disconnect = 10;
    BatteryStateRequest battery_state = 11;
    GlassesInfoRequest glasses_info = 12;
    PairingModeRequest pairing_mode = 13;
    HeadPositionRequest head_position = 14;
    HeadUpAngleConfig head_up_angle = 15;
    PingRequest ping = 16;
    
    // Audio System
    MicStateConfig mic_state = 20;
    VadEnabledConfig vad_enabled = 21;
    VadConfig vad_config = 22;
    
    // Display System - These queue until commit
    DisplayText display_text = 30;
    DisplayImage display_image = 31;
    CacheImage cache_image = 32;  // Renamed from PreloadImage for consistency
    DisplayCachedImage display_cached_image = 33;
    ClearCachedImage clear_cached_image = 34;
    DisplayScrollingText display_scrolling_text = 35;
    DrawLine draw_line = 40;
    DrawRect draw_rect = 41;
    DrawCircle draw_circle = 42;
    DisplayBatch display_batch = 52;  // Send multiple commands at once
    CommitDisplay commit = 43;  // Renders all queued commands
    
    // Display Control - These execute immediately
    DisplayPowerConfig display_power = 36;
    BrightnessConfig brightness = 37;
    AutoBrightnessConfig auto_brightness = 38;
    AutoBrightnessMultiplier auto_brightness_mult = 39;
    DisplayDistanceConfig display_distance = 44;
    DisplayHeightConfig display_height = 45;
    ClearDisplay clear_display = 46;
    DisplayQueueStatus queue_status_request = 51;  // Get queue info
    
    // Dashboard/Cacheboard System
    CacheDashboard cache_dashboard = 47;
    ClearDashboard clear_dashboard = 48;
    ConfigureDashboardTrigger dashboard_trigger = 49;
    
    // User Input
    ImuEnabledConfig imu_enabled = 55;
    ImuSingleRequest imu_single = 56;
    ImuStreamConfig imu_stream = 57;
    HeadGestureConfig head_gesture = 58;
    
    // System Control
    RestartRequest restart = 60;
    FactoryResetRequest factory_reset = 61;
  }
}

// All messages from glasses to phone
message GlassesToPhone {
  oneof payload {
    // Connection Management
    BatteryStatus battery_status = 10;
    ChargingState charging_state = 11;
    DeviceInfo device_info = 12;
    HeadPosition head_position = 13;
    HeadUpAngleResponse head_up_angle_set = 14;
    PongResponse pong = 15;
    
    // Audio System
    VadEvent vad_event = 20;
    
    // Display System  
    ImageTransferComplete image_transfer_complete = 30;
    DisplayQueueInfo display_queue_info = 31;
    
    // User Input
    ImuData imu_data = 40;
    ButtonEvent button_event = 41;
    HeadGesture head_gesture = 42;
    
    // Dashboard System
    DashboardShown dashboard_shown = 43;
  }
}

// ============================================
// Connection Management Messages
// ============================================

message DisconnectRequest {}

message BatteryStateRequest {}

message BatteryStatus {
  uint32 level = 1;  // 0-100 percentage
  bool charging = 2;
}

message ChargingState {
  enum State {
    NOT_CHARGING = 0;
    CHARGING = 1;
  }
  State state = 1;
}

message GlassesInfoRequest {}

message DeviceInfo {
  string fw_version = 1;
  string hw_model = 2;
  DeviceFeatures features = 3;
}

message DeviceFeatures {
  bool camera = 1;
  bool display = 2;
  bool audio_tx = 3;
  bool audio_rx = 4;
  bool imu = 5;
  bool vad = 6;
  bool mic_switching = 7;
  uint32 image_chunk_buffer = 8;  // Max chunks that can be buffered
}

message PairingModeRequest {}

message HeadPositionRequest {}

message HeadPosition {
  int32 angle = 1;  // degrees
}

message HeadUpAngleConfig {
  uint32 angle = 1;  // degrees
}

message HeadUpAngleResponse {
  bool success = 1;
}

message PingRequest {}

message PongResponse {}

// ============================================
// Audio System Messages
// ============================================

message MicStateConfig {
  bool enabled = 1;
}

message VadEnabledConfig {
  bool enabled = 1;
}

message VadConfig {
  uint32 sensitivity = 1;  // 0-100
}

message VadEvent {
  enum State {
    INACTIVE = 0;
    ACTIVE = 1;
  }
  State state = 1;
}

// ============================================
// Display System Messages
// ============================================
//
// DISPLAY QUEUE SYSTEM:
// All display commands (DisplayText, DrawLine, DrawRect, etc.) are queued
// in MCU memory and NOT immediately shown on screen.
// 
// To render queued commands:
// 1. Send multiple display commands (they accumulate in queue)
// 2. Send CommitDisplay to atomically render all queued commands
// 
// Example sequence:
//   → DisplayText{x:10, y:10, text:"Hello"}     // Queued, not shown
//   → DrawLine{x1:0, y1:20, x2:100, y2:20}      // Queued, not shown  
//   → DrawRect{x:50, y:30, width:40, height:20} // Queued, not shown
//   → CommitDisplay{}                            // All 3 render together!
//
// Benefits:
// - No flicker during complex renders
// - Atomic screen updates
// - Reduced display refresh cycles

message DisplayText {
  string text = 1;
  uint32 color = 2;      // RGB565 format (e.g., 0xF800 for red)
  uint32 x = 3;
  uint32 y = 4;
  
  enum FontSize {
    SMALL = 0;
    MEDIUM = 1;
    LARGE = 2;
  }
  FontSize size = 5;     // Font size enum
}

// Initiates bitmap transfer - actual data comes via binary protocol
message DisplayImage {
  string stream_id = 1;   // 2-byte hex string like "002A"
  uint32 x = 2;
  uint32 y = 3;
  uint32 width = 4;
  uint32 height = 5;
  string encoding = 6;    // "rle", "webp", etc.
  uint32 total_chunks = 7;
}

message CacheImage {  // Renamed from PreloadImage
  string stream_id = 1;
  uint32 image_id = 2;    // ID for later reference
  uint32 width = 3;
  uint32 height = 4;
  string encoding = 5;
  uint32 total_chunks = 6;
}

message DisplayCachedImage {
  uint32 image_id = 1;
  uint32 x = 2;
  uint32 y = 3;
  uint32 width = 4;
  uint32 height = 5;
}

message ClearCachedImage {
  uint32 image_id = 1;
}

message DisplayScrollingText {
  string text = 1;
  uint32 color = 2;
  uint32 x = 3;          // Text box X position
  uint32 y = 4;          // Text box Y position  
  uint32 width = 5;      // Text box width (for LVGL wrapping)
  uint32 height = 6;     // Text box height (truncate with ellipses if exceeded)
  
  enum Alignment {
    LEFT = 0;
    CENTER = 1;
    RIGHT = 2;
  }
  Alignment align = 7;
  
  uint32 line_spacing = 8;   // pixels between lines
  uint32 speed = 9;          // pixels/sec scrolling up
  
  enum FontSize {
    SMALL = 0;
    MEDIUM = 1;
    LARGE = 2;
  }
  FontSize size = 10;        // Use enum for font size
  
  bool loop = 11;            // wrap to top when finished
  uint32 pause_ms = 12;      // delay before restart (if looping)
}

message DisplayPowerConfig {
  bool on = 1;  // true = turn on, false = turn off
}

message BrightnessConfig {
  uint32 value = 1;  // 0-100
}

message AutoBrightnessConfig {
  bool enabled = 1;
}

message AutoBrightnessMultiplier {
  float multiplier = 1;  // e.g., 0.8 = 80%
}

message DrawLine {
  uint32 color = 1;
  uint32 stroke = 2;
  uint32 x1 = 3;
  uint32 y1 = 4;
  uint32 x2 = 5;
  uint32 y2 = 6;
}

message DrawRect {
  uint32 color = 1;
  uint32 stroke = 2;
  uint32 x = 3;
  uint32 y = 4;
  uint32 width = 5;
  uint32 height = 6;
}

message DrawCircle {
  uint32 color = 1;
  uint32 stroke = 2;
  uint32 x = 3;
  uint32 y = 4;
  uint32 radius = 5;
}

// Send multiple display commands in a single message (more efficient)
message DisplayBatch {
  repeated DisplayCommand commands = 1;
  
  message DisplayCommand {
    oneof command {
      DisplayText text = 1;
      DisplayCachedImage cached_image = 2;
      DrawLine line = 3;
      DrawRect rect = 4;
      DrawCircle circle = 5;
      DisplayScrollingText scrolling_text = 6;
    }
  }
}

// Commits all queued display commands to screen atomically
// All display commands since last commit are rendered together
message CommitDisplay {
  bool clear_before = 1;  // Optional: clear screen before applying commands
}

// Clears display immediately (NOT queued, happens right away)
message ClearDisplay {}

// Request status of display queue
message DisplayQueueStatus {}

// Response with queue information
message DisplayQueueInfo {
  uint32 queued_commands = 1;  // Number of commands waiting for commit
  uint32 queue_bytes = 2;      // Memory used by queue
  uint32 max_queue_size = 3;   // Maximum queue size in bytes
  bool last_commit_success = 4; // Status of last commit operation
}

message DisplayDistanceConfig {
  uint32 distance_cm = 1;
}

message DisplayHeightConfig {
  uint32 height = 1;
}

message ImageTransferComplete {
  string stream_id = 1;
  
  enum Status {
    OK = 0;
    INCOMPLETE = 1;
  }
  Status status = 2;
  
  repeated uint32 missing_chunks = 3;  // List of missing chunk indices
}

// ============================================
// User Input Messages
// ============================================

message ImuEnabledConfig {
  bool enabled = 1;
}

message ImuSingleRequest {}

message ImuStreamConfig {
  bool enabled = 1;
}

message ImuData {
  Vector3 accel = 1;
  Vector3 gyro = 2;
  Vector3 mag = 3;
}

message Vector3 {
  float x = 1;
  float y = 2;
  float z = 3;
}

message ButtonEvent {
  enum Button {
    CENTER = 0;
    LEFT = 1;
    RIGHT = 2;
  }
  Button button = 1;
  
  enum State {
    UP = 0;
    DOWN = 1;
  }
  State state = 2;
}

message HeadGesture {
  enum Gesture {
    NOD = 0;
    SHAKE = 1;
    HEAD_UP = 2;
    HEAD_DOWN = 3;
    TILT_LEFT = 4;
    TILT_RIGHT = 5;
  }
  Gesture gesture = 1;
}

message HeadGestureConfig {
  HeadGesture.Gesture gesture = 1;
  bool enabled = 2;
}

// ============================================
// System Control Messages
// ============================================

message RestartRequest {}

message FactoryResetRequest {}

// ============================================
// Dashboard/Cacheboard System Messages
// ============================================

// Cache a complete dashboard/screen that can be triggered instantly
message CacheDashboard {
  uint32 dashboard_id = 1;  // ID for this dashboard
  
  // Series of display commands that make up the dashboard
  // When dashboard triggers, these commands are queued and committed atomically
  DisplayBatch batch = 2;  // Reuse the same DisplayBatch structure
}

// Clear a cached dashboard from memory
message ClearDashboard {
  uint32 dashboard_id = 1;
}

// Configure what triggers the dashboard display
message ConfigureDashboardTrigger {
  uint32 dashboard_id = 1;
  
  enum TriggerType {
    HEAD_UP = 0;      // Even Realities style - look up
    HEAD_DOWN = 1;    
    BUTTON_TAP = 2;   // Vuzix Z100 style - tap button
    MANUAL_ONLY = 3;  // Only show when explicitly commanded
  }
  TriggerType trigger = 2;
  
  // Optional: minimum duration for gesture (milliseconds)
  uint32 duration_ms = 3;
}

// Event sent when dashboard is shown by glasses autonomously
message DashboardShown {
  uint32 dashboard_id = 1;
  
  enum TriggerSource {
    GESTURE = 0;
    BUTTON = 1;
    MANUAL = 2;
  }
  TriggerSource source = 2;
}